{% extends "base.html" %}

{% block content %}
<div class="row">
  <div class="col-md-5">
    <div class="card shadow-sm mb-3">
      <img src="{{ url_for('static', filename='img/' ~ product.product_id ~ '.jpeg') }}"
            class="card-img-top"
            alt="{{ product.name }}">
      <div class="card-body">
        <h3 class="card-title">{{ product.name }}</h3>
        <p class="text-muted mb-1">
          {{ product.category|capitalize }} &middot; {{ product.gender|capitalize }} &middot; {{ product.color|capitalize }}
        </p>
        <p class="mb-1">
          <span class="text-muted small">MRP:</span>
          <span class="text-decoration-line-through text-muted">₹{{ "%.0f"|format(mrp) }}</span>
        </p>
        <p class="mb-1">
          <span class="fw-bold fs-4 text-success">₹{{ "%.0f"|format(current_price) }}</span>
          <span class="badge bg-success-subtle text-success ms-2">
            {{ "%.1f"|format(current_discount_pct) }}% off
          </span>
        </p>

        <form method="get" class="mt-3">
          <label for="size" class="form-label fw-semibold">Select size (UK):</label>
          <div class="input-group">
            <select id="size" name="size" class="form-select">
              {% for s in sizes %}
                <option value="{{ s }}" {% if s == selected_size %}selected{% endif %}>
                  {{ s }}
                </option>
              {% endfor %}
            </select>
            <button class="btn btn-outline-primary" type="submit">Update</button>
          </div>
        </form>

        <p class="mt-3 mb-0 small text-muted">
          Inventory for size {{ selected_size }}: <strong>{{ latest_row.inventory_level }}</strong> pairs
        </p>
        <p class="mb-0 small text-muted">
          Avg rating: ⭐ {{ "%.1f"|format(latest_row.rating_avg) }} ({{ latest_row.num_reviews }} reviews)
        </p>
      </div>
    </div>

    <div class="card shadow-sm mb-3 border-info">
      <div class="card-body">
        <h5 class="card-title">Smart Sneaks Recommendation</h5>
        <p class="mb-1">
          <strong>Buy Now?</strong>
          {% if recommendation.is_good_buy %}
            <span class="badge bg-success ms-2">Yes</span>
          {% else %}
            <span class="badge bg-warning text-dark ms-2">Better Wait</span>
          {% endif %}
        </p>
        <p class="mb-1 small text-muted">
          Model confidence (good buy): {{ "%.1f"|format(recommendation.prob_good_buy * 100) }}%
        </p>
        <p class="mb-1">
          <strong>Expected max future drop:</strong>
          ~{{ "%.1f"|format(recommendation.predicted_future_drop_pct) }}%
        </p>
        <p class="mt-2">{{ recommendation.recommendation_text }}</p>

        {% if best_buy_date_2026 %}
        <p class="small text-primary mb-1">
          Best estimated price in 2026 around: <strong>{{ best_buy_date_2026 }}</strong>
          (approx. ₹{{ "%.0f"|format(best_buy_price_2026) }})
        </p>
        <p id="countdown" class="small text-muted mb-2"></p>
        {% endif %}

        <hr>
        <p class="small text-muted mb-0">
          Why? {{ recommendation.reason_explanation }}
        </p>
      </div>
    </div>
  </div>

  <div class="col-md-7">
    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <h5 class="card-title">Price History for Size {{ selected_size }}</h5>
        <canvas id="priceHistoryChart"></canvas>
      </div>
    </div>

    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <h5 class="card-title">Estimated Future Best Price</h5>
        <p class="small text-muted">
          Based on the model's expected future drop, Smart Sneaks estimates a possible
          best price of around <strong>₹{{ "%.0f"|format(estimated_best_price) }}</strong>
          within the next 30 days.
        </p>
        <canvas id="futurePriceChart"></canvas>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script type="application/json" id="ss-data">
{{ {
    'dates': dates,
    'prices': prices,
    'current_price': current_price,
    'estimated_best_price': estimated_best_price,
    'future_date_label': future_date_label,
    'best_buy_date_2026': best_buy_date_2026|default(None)
  } | tojson }}
</script>
<script>
(function() {
    // Local scope — no conflicts, no redeclaration warnings

    // Use a single window-level cache to avoid redeclaring block-scoped variables
    window.__ss_cache__ = window.__ss_cache__ || {};
    var __ss_cache = window.__ss_cache__;

    // Load server-provided data from a non-executable JSON block to avoid Jinja tokens inside JS
    var __ss_server_data = {};
    try {
        __ss_server_data = JSON.parse(document.getElementById('ss-data').textContent || '{}');
    } catch (e) {
        __ss_server_data = {};
    }

    var dates = (__ss_cache.dates !== undefined) ? __ss_cache.dates : (__ss_cache.dates = __ss_server_data.dates || []);
    var prices = (__ss_cache.prices !== undefined) ? __ss_cache.prices : (__ss_cache.prices = __ss_server_data.prices || []);
    var currentPrice = (__ss_cache.currentPrice !== undefined) ? __ss_cache.currentPrice : (__ss_cache.currentPrice = __ss_server_data.current_price || 0);
    var estimatedBestPrice = (__ss_cache.estimatedBestPrice !== undefined) ? __ss_cache.estimatedBestPrice : (__ss_cache.estimatedBestPrice = __ss_server_data.estimated_best_price || 0);
    var futureLabel = (__ss_cache.futureLabel !== undefined) ? __ss_cache.futureLabel : (__ss_cache.futureLabel = __ss_server_data.future_date_label || '');

    // ------- Price History Chart -------
    const ctxHistory = document.getElementById('priceHistoryChart').getContext('2d');
    new Chart(ctxHistory, {
        type: 'line',
        data: {
            labels: dates,
            datasets: [{
                label: 'Selling price (₹)',
                data: prices,
                tension: 0.3,
                fill: false,
            }]
        },
        options: {
            responsive: true,
            scales: {
                x: {
                    ticks: { maxRotation: 45, minRotation: 45 }
                }
            }
        }
    });

    // ------- Future Price Comparison Chart -------
    const ctxFuture = document.getElementById('futurePriceChart').getContext('2d');
    new Chart(ctxFuture, {
        type: 'bar',
        data: {
            labels: ['Today', futureLabel],
            datasets: [{
                label: 'Price (₹)',
                data: [currentPrice, estimatedBestPrice]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false }
            }
        }
    });
        // ------- Countdown to best 2026 date (if available) -------
    var bestDateStr = (__ss_server_data.best_buy_date_2026 !== undefined && __ss_server_data.best_buy_date_2026 !== null)? __ss_server_data.best_buy_date_2026: null;
    function updateCountdown() {
        if (!bestDateStr) return;
        var target = new Date(bestDateStr + "T00:00:00");
        var now = new Date();

        var diff = target - now;
        var el = document.getElementById('countdown');
        if (!el) return;

        if (diff <= 0) {
            el.textContent = "Best buy window in 2026 is active or has passed.";
            return;
        }

        var days = Math.floor(diff / (1000 * 60 * 60 * 24));
        var hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
        var mins = Math.floor((diff / (1000 * 60)) % 60);

        el.textContent = "Time until best 2026 price: " + days + "d " + hours + "h " + mins + "m";
    }

    updateCountdown();
    setInterval(updateCountdown, 60000);  
    
    // update every minute
})();   // End IIFE
</script>
{% endblock %}